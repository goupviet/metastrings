<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>metastrings v2 - a NoSQL database</title>
    <style>
        body  {
            font-family: Verdana, sans-serif;
            margin: 0;
			overflow: scroll;
        }

        pre {
            font-family: 'Courier New', monospace;
        }

        #pageHeader {
            font-size: large;
            font-weight: bold;
            padding-top: 1em;
        }

        #navbar {
            background-color: lightblue;
            width: 20em;
            height: 100%;
            margin: 0;
            position: fixed;
            overflow: auto;
        }

        #contentsHeader {
            font-size: large;
        }

        .contentGroupHeader {
            margin-left: 10px;
            font-weight: bold;
        }

        #contentDiv {
            margin-left: 20em;
            padding-left: 1em;
        }
		
		#projectVersion {
			margin-left: 1em;
		}

        .topic {
            font-weight: bolder;
            font-size: larger;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
</head>
<body>
    <div id=navbar>
		<div class=contentGroupHeader>metastrings v2</div>
        <ul>
            <li><a href="#whatis">What is metastrings?</a></li>
            <li><a href="#features">Why metastrings?</a></li>
            <li><a href="#installation">Installation</a></li>
        </ul>
		
        <div class=contentGroupHeader>Contact</div>
        <ul>
			<li><a href="mailto: contact@metastrings.io">contact@metastrings.io</a></li>
		</ul>

        <div class=contentGroupHeader>Libraries</div>
        <ul>
            <li>
                <a href="#lib-mechanics">Classes you use</a>
                <ol>
                    <li><a href="#Context">Context</a></li>
                    <li><a href="#Command">Command</a></li>
                    <li><a href="#Define">Define</a></li>
                    <li><a href="#Select">Select</a></li>
                </ol>
            </li>
            <li>
                <a href="#lib-types">Implementation classes</a>
                <ol>
                    <li><a href="#Tables">Tables</a></li>
                    <li><a href="#Items">Items</a></li>
                    <li><a href="#Names">Names</a></li>
                    <li><a href="#Values">Values</a></li>
                    <li><a href="#NameValues">NameValues</a></li>
                    <li><a href="#LongStrings">LongStrings</a></li>
                    <li><a href="#Schema">Schema Diagram</a></li>
                </ol>
            </li>
            <li>
                <a href="#utils">utils</a>
                <ol>
                    <li><a href="#ListDictionary">ListDictionary</a></li>
                    <li><a href="#ScopeTiming">ScopeTiming</a></li>
                    <li><a href="#Types">Types</a></li>
                    <li><a href="#Utils">Utils</a></li>
                    <li><a href="#Metaq">metaq</a></li>
                </ol>
            </li>
        </ul>
    </div>

    <div id=contentDiv>
        <div id=pageHeader>metastrings - a NoSQL database</div>
        <h1><a name=whatis>What is metastrings?</a></h1>
        <b>metastrings</b> is a NoSQL database built on top of MySQL.  
		It consists of a MySQL schema, and a .NET class library that you program against.
		
		<br>
		<br>
		
		metastrings powers <a target=_blank href="https://www.balognabeats.com">Balogna Beats</a>, 
		a web application for creating, sharing, and enjoying drum beats.
		<a target=_blank href="https://www.balognabeats.com/metastrings.aspx">Here's info</a>
		on how Balogna Beats uses metastrings.
		
		<br>
		<br>
        
		See how simple it is to add a row to a table:
<pre class="prettyprint lang-cs">

// Lacking a column for the primary key, use a GUID
string userKey = Guid.NewGuid().ToString();

Define define = new Define("users", userKey); // table name, primary key value

// Supply the column data.
define.SetData("email", email);
define.SetData("name", name);
define.SetData("logintoken", "");
define.SetData("blocked", 0);

// Do the UPSERT.
await ctxt.Cmd.DefineAsync(define);
</pre>
		Just load up the Define object and have ctxt.Cmd.DefineAsync do the work.
		Think of how much SQL that would have taken!
		
		<br>
		<br>
		
		And you could have done that with the "users" table not yet defined; this call would have created the table automatically.
		
		<br>
		<br>
		
		To add a new column, load up the Define with another call to SetData for the new column name and value.

		<br>
		<br>
		
		To access data in a metastrings table to get the row IDs and titles from the beats table:
<pre class="prettyprint lang-cs">
var select =
    Sql.Parse
    (
        "SELECT id, title FROM beats " +
        "WHERE userid = @userId AND ispublic = @public " +        
        "ORDER BY title ASC"
    );
select.AddParam("@userId", result.id);
select.AddParam("@public", 1);
using (var reader = await ctxt.ExecSelectAsync(select))
{
    while (await reader.ReadAsync())
    {
        var newBeat =
            new SearchBeat()
            {
                id = reader.GetInt64(0),
                title = reader.GetString(1)
            };
        result.beats.Add(newBeat);
    }
}
</pre>	
		See the Sql.Parse, that turns the metastrings SQL query into a MySQL SQL query,
		that's where the magic happens.  
		So you just send your SQL in, pass in your parameters, then you do typical database programming.
		
		<br>
		<br>
		
		The query looks like beats of a particular userid.  
		No need to specify an index; all columns are automatically indexed.
		One less thing to worry about.
		
        <h1><a name=features>Why metastrings?</a></h1>
        <ol>
            <li>Dynamic schema: transparently add new columns and ignore stale columns</li>
            <li>Automatic indexing on every column, including full-text</li>
            <li>Internally normalized storage supports simple denormalized schemas</li>
            <li>High productivity application development</li>
        </ol>

        <h2><a name="installation">Installation</a></h2>
		<ol>
			<li>Get the source from <a target=_blank href="https://github.com/michaelsballoni/metastrings2">GitHub</a>.
			<li>Build the source using Microsoft Visual Studio 2019.
			<li>Provision a new MySQL database schema, call it "metastrings".
			<li>Create the metastring schema using the "metastrings - schema.sql" file in the source repository under "schema"
			<li>Integrate the metastrings project into your solution by addding a reference to metastring's mslib project
			<li>In your application project configuration file, create a DB connection string setting named "metastrings" with a connection string addressing the schema you created above
			<li>To start using metastrings in your code, know that metastrings uses the "metastrings" namespace
			<li>
				You can start by using
				<a target=_blank href="https://www.balognabeats.com/metastrings.aspx#define">Define</a> to create metastrings schema and upsert data,
				and <a target=_blank href="https://www.balognabeats.com/metastrings.aspx#select">Select</a> to get data out
			</li>
		</ol>
		
        <h2>metastrings vs. metastrings2</h2>
        In github you'll notice metastrings and metastrings2 projects.
        <br><br>
        metastrings(v1) supported a wide variety applications using SqLite or MySQL,
        but had an Achille's heel with the schema lacking unique indexes, 
        requiring locking tables to maintaining data integrity.
        <br><br>
        metastring(v2) is focused as an extension to MySQL, and it solves the ingest problem by limiting value lengths
        and using unique indexes.  A separate mechanism is provided for working with long strings.
        <br><br>
        Documentation for metastrings(v1) is found <a href="v1/index.html">here</a>
        <h3><a name=lib-mechanics>Classes you use</a></h3>
        <ul>
            <li>
                <a class=topic name=Context>Context</a> -
                manages the MySQL database connection and provides many helpful database query functions
            </li>
            <li>
                <a class=topic name=Command>Command</a> -
                implementation of metastrings API, in a manner akin to JSON-in / JSON-out programming
                <br>
                The main functions are DefineAsync for UPSERT, (Query)GetAsync for getting metadata for items, and DeleteAsync for removing items
            </li>
            <li>
                <a class=topic name=Define>Define</a> - class for adding data to the database
                -
                <a target=_blank href="https://www.balognabeats.com/metastrings.aspx#define">Balogna Beats Define Example</a>
            </li>
            <li>
                <a class=topic name=Select>Select</a> - the Sql class takes Select objects, including query parameters
                and converts that into a SQLite/MySQL SQL statement, which ctxt.Execute... executes.
                -
                <a target=_blank href="https://www.balognabeats.com/metastrings.aspx#select">Balogna Beats Select Example</a>
            </li>
        </ul>

        <h3><a name=lib-types>Implementation types</a></h3>
        These classes implement the core NoSQL functionality
        <ul>
            <li><a class=topic name=Tables>Tables</a> - the schema and primary key definition</li>
            <li><a class=topic name=Items>Items</a> - the rows of the database</li>
            <li><a class=topic name=Names>Names</a> - the columns of the database</li>
            <li><a class=topic name=Values>Values</a> - the row data</li>
            <li><a class=topic name=NameValues>NameValues</a> - get name-values literals from ids</li>
            <li><a class=topic name=LongStrings>LongStrings</a> - support for long text strings</li>
			<li><a class=topic name=Schema>Schema Diagram</a><br><img src="diagram2.png"></li>
        </ul>

        <h3><a name=utils>utils</a></h3>
        Core classes for implementing the project
        <ul>
            <li>
                <a class=topic name=ListDictionary>ListDictionary</a>
                <br>
                A List/Dictionary hybrid, used to keep the order of KeyValue Adds as the order of KeyValue iteration
                <br>
                This is needed for maintaining the order of keys added in to match the order of values read out
            </li>
            <li>
                <a class=topic name=ScopeTiming>ScopeTiming</a>
                -
                Lightweight timing framework for establishing performance profiles
            </li>
            <li>
                <a class=topic name=Types>Types</a>
                -
                Central location for the little types used throughout the codebase,
                like MetaStringException
            </li>
			
            <li>
                <a class=topic name=Utils>Utils</a> - Low-level static class for getting things done
                <ol>
                    <li>HashString - SHA-256</li>
                    <li>Serialize / Deserialize - JSON wrappers</li>
                    <li>BatchUp - turn a bunch of individual SQL statements into batches of SQL of the same size</li>
                    <li>SplitItUp - turn a list of items into a number of lists of items</li>
                    <li>HandleException - robust WebException error handling</li>
                    <li>ConvertDbInt... - DB null-handling number getting</li>
                    <li>CleanName - make a unique column valid name for SQL building</li>
                    <li>
                        IsWord / IsParam / IsNameReserved / Validate...
                        <br>
                        validation of tokens to keep columns, parameters, and operations SQL clean
                    </li>
                </ol>
            </li>
        </ul>

        <a name=Metaq><h3>metaq</h3></a>
        metaq is a powerful tool for accessing the database and troubleshooting queries.
        You enter your SQL query, then the value for each parameter in the query,
        and it writes your query, then the MySQL query generated by metastrings to metaq.log
        in the current directory.
        It also writes the query results to that file, so you get a complete query-to-results snapshot.
        <pre>
> select id, title from beats where title matches @title

@title: Fresh

id: 734348
title: Fresh One
relevance: 2.353236198425293
===
Results: 1

></pre>
    </div>
</body>
</html>
